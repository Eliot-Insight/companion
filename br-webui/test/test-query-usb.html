<script>
    var companionDevices =
    {

        "Video" : {
            "searchPattern":"/dev/video*",
            "queryCallback":handleVideoDevices,
            "devices": [],
            "companionDevices": []
        },
        "Audio" : {
            "searchPattern":"/dev/snd/*",
            "queryCallback":handleAudioDevices,
            "devices": [],
            "companionDevices": []
        },
        "Serial" : {
            "searchPattern":"/dev/serial/by-id/*",
            "queryCallback":handleSerialDevices,
            "devices": [],
            "companionDevices": []
        }
    }

    function loaded() {
        console.log("*~!~*~!~*~!~query-usb-loaded~!~*~!~*~!~*");
    }

    function queryUsb(pattern, callback) {
        var xhr = new XMLHttpRequest();
        var query = "?pattern=" + pattern;
        console.log("query", query);

        xhr.open("GET", "/udevadm" + query, true);

        xhr.addEventListener("readystatechange", callback, true);
        xhr.send();
    }

    function companionDevicesInResult(result) {
        // usb.target refers to the XMLHttpRequest object ('xhr')
        // wait for readyState == 4 ~ "Done"
        if (result.target.readyState != 4) {
            return null;
        }
        var newDevices = [];
        usbInfo = JSON.parse(result.target.response);
        
        for (device in usbInfo.devices) {
            deviceInfo = usbInfo.devices[device]
            if (deviceInfo["companion-device"]) {
                newDevices.push(deviceInfo["companion-device"]);
            }
        }
        return newDevices;
    }

    function deviceNamesInResult(result) {
        if (result.target.readyState != 4) {
            return null;
        }

        var newDevices = [];
        usbInfo = JSON.parse(result.target.response);
        for (device in usbInfo.devices) {
            deviceInfo = usbInfo.devices[device]
            if (deviceInfo["udev-info"]["ID_MODEL"]) {
                newDevices.push(deviceInfo["udev-info"]["ID_MODEL"]);
            }
        }
        return newDevices;
    }

    function handleResponse(deviceType, response) {
        console.log("got query response", deviceType, response);

        var cDevices = companionDevicesInResult(response);
        var devices = deviceNamesInResult(response);
        if (!devices && !companionDevices) {
            return;
        }
        companionDevices[deviceType].companionDevices = cDevices;
        companionDevices[deviceType].devices = devices;
        companionDevices[deviceType].response = response.target.response;
        updateHtmlContent();
    }

    // TODO figure this out w simpler? css
    function updateHtmlContent() {
        var deviceContent = document.getElementById("deviceContent");
        //deviceContent.innerHtml = "";
        while (deviceContent.hasChildNodes()) {
            deviceContent.removeChild(deviceContent.lastChild);
        }
        for (deviceType in companionDevices) {
            var h = document.createElement("h1");
            h.innerHTML = deviceType + ":";
            var h4 = document.createElement("h4");
            h4.innerHTML = companionDevices[deviceType]["devices"];

            var b = document.createElement("b");
            b.innerHTML = companionDevices[deviceType]["companionDevices"];

            deviceContent.appendChild(h);
            deviceContent.appendChild(h4);
            deviceContent.appendChild(b);
        }
    }

    function handleSerialDevices(result) {
        handleResponse("Serial", result);
    }
    function handleVideoDevices(result) {
        handleResponse("Video", result);
    }
    function handleAudioDevices(result) {
        handleResponse("Audio", result);
    }

    loaded();

    for (deviceType in companionDevices) {
        queryUsb(companionDevices[deviceType].searchPattern, companionDevices[deviceType].queryCallback);
    }
</script>

<div id="deviceContent"></div>
