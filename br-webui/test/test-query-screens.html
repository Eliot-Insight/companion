<script>
    var companionScreens = {
        "root" : [],
        "pi" : []
    }
    
    function loaded() {
        console.log("*~!~*~!~*~!~query-screens-loaded~!~*~!~*~!~*");
    }

    function queryScreens(user, callback) {
        var xhr = new XMLHttpRequest();
        var query = "?user=" + user;
        console.log("query", query);

        xhr.open("GET", "/screen" + query, true);

        xhr.addEventListener("readystatechange", callback, true);
        xhr.send();
    }

    function handleResponse(deviceType, response) {
        if (response.target.readyState != 4) {
            return null;
        }
        console.log("got query response", deviceType, response);

        jsonReply = JSON.parse(response.target.response);
        
        companionScreens[jsonReply.user] = jsonReply.screens

        updateHtmlContent();
    }

    // TODO figure this out w simpler? css
    function updateHtmlContent() {
        var screenContent = document.getElementById("screenContent");
        while (screenContent.hasChildNodes()) {
            screenContent.removeChild(screenContent.lastChild);
        }
        for (user in companionScreens) {
            var h = document.createElement("h3");
            h.innerHTML = user + ":";
            var ul = document.createElement("ul");
            for (screen in companionScreens[user])
            {
                var li = document.createElement("li");

                li.innerHTML = companionScreens[user][screen]["idName"] + " (" + companionScreens[user][screen]["idNum"] + ")";
                ul.appendChild(li);
            }
            screenContent.appendChild(h);
            screenContent.appendChild(ul);
        }
    }

    loaded();

    for (let user in companionScreens) {
        queryScreens(user, function (res) {
            return handleResponse(user, res);
        });
    }
</script>

<div id="screenContent"></div>
